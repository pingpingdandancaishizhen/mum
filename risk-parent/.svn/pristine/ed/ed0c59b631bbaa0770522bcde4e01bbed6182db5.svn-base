<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="cn.sunfit.risk.buz.server.dao.p2p.activiti.BPDAO" >
  <resultMap id="BaseResultMap" type="cn.sunfit.risk.buz.api.beans.p2p.activiti.BP" >
    <id column="bp_id" property="bpId" jdbcType="VARCHAR" />
    <result column="corp_id" property="corpId" jdbcType="VARCHAR" />
    <result column="bp_def_id" property="bpDefId" jdbcType="VARCHAR" />
    <result column="bp_no" property="bpNo" jdbcType="VARCHAR" />
    <result column="product_type" property="productType" jdbcType="VARCHAR" />
    <result column="bp_status" property="bpStatus" jdbcType="TINYINT" />
    <result column="engine_key" property="engineKey" jdbcType="VARCHAR" />
    <result column="current_task_key" property="currentTaskKey" jdbcType="VARCHAR" />
    <result column="current_task_id" property="currentTaskId" jdbcType="VARCHAR" />
    <result column="current_task_name" property="currentTaskName" jdbcType="VARCHAR" />
     <result column="create_user_id" property="createUserId" jdbcType="VARCHAR" />
    <result column="create_time" property="createTime" jdbcType="TIMESTAMP" />
    <result column="update_time" property="updateTime" jdbcType="TIMESTAMP" />
    <result column="channel" property="channel" jdbcType="VARCHAR"/>
    <result column="loan_info_id" property="loanInfoId" jdbcType="VARCHAR"/>
  </resultMap>
  
  <resultMap id="TodoQueryResultMap" type="cn.sunfit.risk.buz.api.beans.p2p.activiti.TodoQueryDTO" >
    <id column="task_id" property="taskId" jdbcType="VARCHAR" />
    <result column="bp_id" property="bpId" jdbcType="VARCHAR" />
    <result column="customer_id" property="customerId" jdbcType="VARCHAR" />
    <result column="product_id" property="productId" jdbcType="VARCHAR" />
    <result column="bp_def_id" property="bpDefId" jdbcType="VARCHAR" />
    <result column="bp_def_key" property="bpDefKey" jdbcType="VARCHAR" />
    <result column="bp_no" property="bpNo" jdbcType="VARCHAR" />
    <result column="task_name" property="taskName" jdbcType="VARCHAR" />
    <result column="cust_name" property="custName" jdbcType="VARCHAR" />
    <result column="cust_gender" property="custGender" jdbcType="VARCHAR" />
    <result column="cust_license_num" property="custLicenseNum" jdbcType="VARCHAR" />
    <result column="cust_mobile" property="custMobile" jdbcType="VARCHAR" />
    <result column="cust_type" property="custType" jdbcType="VARCHAR" />
    <result column="product_type" property="productType" jdbcType="VARCHAR" />
    <result column="create_time" property="createTime" jdbcType="TIMESTAMP" />
    <result column="apply_amount" property="applyAmount" jdbcType="DECIMAL" />
    <result column="loan_usage" property="loanUsage" jdbcType="VARCHAR" />
    <result column="loan_apply_daylyTerm" property="loanApplyDaylyTerm" jdbcType="VARCHAR" />
    <result column="loan_apply_monthlyTerm" property="loanApplyMonthlyTerm" jdbcType="VARCHAR" />
    <result column="loanapproval_repaymentTypes" property="loanApprovalRepaymentMethod" jdbcType="VARCHAR" />
        <result column="loan_approval_amount" property="loanApprovalAmount" jdbcType="DECIMAL" />
        <result column="loan_approval_daylyTerm" property="loanApprovalDaylyTerm" jdbcType="VARCHAR" />
    	<result column="loan_approval_monthlyTerm" property="loanApprovalMonthlyTerm" jdbcType="VARCHAR" />
    <result column="loancar_license_plate" property="plate" jdbcType="VARCHAR" />
    <result column="loancar_car_brand" property="loancarCarBrand" jdbcType="VARCHAR" />
    <result column="create_user_id" property="createUserId" jdbcType="VARCHAR" />
    <result column="current_task_name" property="currentTaskName" jdbcType="VARCHAR" />
    <result column="product_name" property="productName" jdbcType="VARCHAR" />
    <result column="brand_name" property="brandName" jdbcType="VARCHAR" />
    <result column="user_name" property="userName" jdbcType="VARCHAR" />
    <result column="dept_name" property="deptName" jdbcType="VARCHAR" />
    <result column="dept_id" property="deptId" jdbcType="VARCHAR" />
    <result column="dept_head" property="deptHead" jdbcType="VARCHAR" />
    <result column="corporation" property="corporation" jdbcType="VARCHAR" />
    <result column="loan_money" property="loanMoney" jdbcType="DECIMAL" />
    <result column="order_add_time" property="orderAddTime" jdbcType="TIMESTAMP" />
    <result column="loan_info_id" property="loanInfoId" jdbcType="VARCHAR" />
    <result column="aprove_status" property="aproveStatus" jdbcType="VARCHAR" />
    
  </resultMap>
  
  <sql id="Base_Column_List" >
    bp_id, corp_id, bp_def_id, bp_no, product_type, bp_status, engine_key, current_task_key, current_task_id,
     create_user_id, create_time, update_time,current_task_name,channel,loan_info_id
  </sql>
  <select id="findById" resultMap="BaseResultMap"  >
    select 
    <include refid="Base_Column_List" />
    from ${domain}_risk_bps
    where bp_id = #{bpId,jdbcType=VARCHAR}
  </select>
  
  <sql id="BP_Base_COL">
  base.bp_id ,base.task_name,base.bp_no,base.current_task_name,
  base.bp_def_id,
  base.bp_def_key,base.task_id,
  cd.id dept_id,
  p.product_code product_id,cu.user_name ,
  p.product_type product_type,i.id loan_info_id,i.aprove_status,
i.company_name corporation,i.product_name ,i.customer_type cust_type  ,i.customer_name cust_name,i.id_card cust_license_num,i.create_time order_add_time, i.loan_period loan_apply_daylyTerm ,i.loan_period loan_apply_monthlyTerm  ,i.loan_money loan_approval_amount
,base.plate
</sql>
  
  <update id="update"  parameterType="cn.sunfit.risk.buz.api.beans.p2p.activiti.BP">
    update ${domain}_risk_bps
    set corp_id = #{corpId,jdbcType=VARCHAR},
      bp_def_id = #{bpDefId,jdbcType=VARCHAR},
      bp_no = #{bpNo,jdbcType=VARCHAR},
      product_type = #{productType,jdbcType=VARCHAR},
      bp_status = #{bpStatus,jdbcType=TINYINT},
      engine_key = #{engineKey,jdbcType=VARCHAR},
      current_task_key = #{currentTaskKey,jdbcType=VARCHAR},
      current_task_id = #{currentTaskId,jdbcType=VARCHAR},
      create_user_id = #{createUserId,jdbcType=VARCHAR},
      create_time = #{createTime,jdbcType=TIMESTAMP},
      update_time = #{updateTime,jdbcType=TIMESTAMP},
      current_task_name=#{currentTaskName}
    where bp_id = #{bpId,jdbcType=VARCHAR}
  </update>
  
    <insert id="insertBp"  parameterType="cn.sunfit.risk.buz.api.beans.p2p.activiti.BP">
    insert into ${domain}_risk_bps (bp_id, corp_id, bp_def_id, 
      bp_no, product_type, bp_status, 
      engine_key, current_task_key, current_task_id,
      create_user_id, create_time, update_time,current_task_name,channel,loan_info_id
      )
    values (#{bpId,jdbcType=VARCHAR}, #{corpId,jdbcType=VARCHAR}, #{bpDefId,jdbcType=VARCHAR}, 
      #{bpNo,jdbcType=VARCHAR}, #{productType,jdbcType=VARCHAR}, #{bpStatus,jdbcType=TINYINT}, 
      #{engineKey,jdbcType=VARCHAR}, #{currentTaskKey,jdbcType=VARCHAR},  #{currentTaskId,jdbcType=VARCHAR}, 
      #{createUserId,jdbcType=VARCHAR}, #{createTime,jdbcType=TIMESTAMP}, #{updateTime,jdbcType=TIMESTAMP},#{currentTaskName},
      #{channel},#{loanInfoId}
      )
  </insert>
  
  
  <select id="getProductByBpId" parameterType="java.util.Map" resultType="string">
  	select product_type from ${domain}_risk_bps where bp_id = #{bpId} limit 1;
  </select>
  
  
  <select id="selectFeeConfigByBpId"  resultType="java.lang.String">
  	SELECT p.fee_config from  ${domain}_risk_bps r ,${domain}_p2p_product p 
	where p.id = r.product_type
	and r.bp_id = #{bpId,jdbcType=VARCHAR}
  </select>
  <sql id="TASK_Base_TABLE">
  	SELECT
		TASK.ID_ task_id,
		TASK.NAME_ task_name,
		bp.bp_id,
		bp.bp_no,
		bp.product_type,
		bp.create_time,
		bp.create_user_id,
		bp.current_task_key,
		bp.current_task_name,
		bp.bp_def_id,
		bp.bp_status,
		bp.loan_info_id
		,bp.update_time
	FROM
		(
			SELECT DISTINCT
				RES.ID_,
				RES.NAME_
			FROM
				ACT_RU_TASK RES
			LEFT JOIN ACT_RU_IDENTITYLINK I ON I.TASK_ID_ = RES.ID_
			WHERE
				(
					RES.ASSIGNEE_ = #{uid}
					OR (
						RES.ASSIGNEE_ IS NULL
						AND I.TYPE_ = 'candidate'
						AND (I.USER_ID_ = #{uid})
					)
				)
		) TASK,
		${domain}_risk_bps bp
	WHERE
		bp.current_task_id LIKE concat('%', TASK.ID_, '%')
  </sql>
  <sql id="Todo_Base_TABLE">
  	SELECT
			bp.task_id ,bp.task_name ,bp.bp_id ,bp.bp_no ,bp.product_type ,bp.bp_def_id ,
			bp.create_time ,bp.create_user_id ,
			bp.current_task_key,bp.current_task_name,bp.bp_status ,bm.bp_def_key,bp.loan_info_id,bp.update_time
			,(SELECT attr_value from rjs_bp_attrs where bp_id=bp.bp_id and attr_name='loancar_license_plate') plate
		from (
			<include refid="TASK_Base_TABLE"/>
		) bp,
		${domain}_bp_meta bm 
	WHERE
		bp.bp_def_id = bm.bp_def_id
  </sql>
  <select id="selectTodoList" resultMap="TodoQueryResultMap" parameterType="cn.sunfit.risk.buz.api.beans.p2p.activiti.TodoQueryReq">
  	SELECT 
  		<include refid="BP_Base_COL"/> 
		from (
			<include refid="Todo_Base_TABLE"/>
		) base 
		LEFT JOIN risk_corp_user cu on base.create_user_id = cu.id
		LEFT JOIN risk_corp_dept cd on cu.dept_id = cd.id
		JOIN ${domain}_loan_info i  on base.loan_info_id=i.id
		LEFT JOIN ${domain}_p2p_product p ON p.product_code=i.product_code
	where 
		1 = 1
	<if test="productType != null and productType != ''">
		and base.product_type = #{productType,jdbcType=VARCHAR}
	</if>
	<if test="bpNo != null and bpNo != ''">
		and base.bp_no like concat('%',#{bpNo,jdbcType=VARCHAR},'%')
	</if>
	<if test="custName != null and custName != ''">
		and base.cust_name like concat('%',#{custName,jdbcType=VARCHAR},'%')
	</if>
	<if test="custLicenseNum != null and custLicenseNum != ''">
		and base.cust_license_num like concat('%',#{custLicenseNum,jdbcType=VARCHAR},'%')
	</if>
	<if test="custType != null and custType != ''">
		and base.cust_type = #{custType,jdbcType=VARCHAR}
	</if>
	<if test="loancarLicensePlate != null and loancarLicensePlate != ''">
		and base.plate like concat('%',#{loancarLicensePlate,jdbcType=VARCHAR},'%')
	</if>
	<if test="startDate != null and endDate !=null ">
    	and i.create_time between #{startDate,jdbcType=TIMESTAMP} and #{endDate,jdbcType=TIMESTAMP}
    </if>
    <if test="currentTaskKey != null and currentTaskKey !='' ">
    	and base.current_task_key like concat('%,',#{currentTaskKey,jdbcType=VARCHAR},',%') 
    </if>
     <if test="loanSource != null and loanSource !='' ">
    	and i.corporation like concat('%,',#{loanSource,jdbcType=VARCHAR},',%') 
    </if>
    <if test="aproveStatus != null and aproveStatus !='' ">
    	and i.aprove_status =#{aproveStatus}
    </if>
    
	order by base.update_time desc
  </select>
</mapper>