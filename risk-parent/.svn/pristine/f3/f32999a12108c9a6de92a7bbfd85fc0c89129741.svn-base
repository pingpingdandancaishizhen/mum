<template>
  <div :class="!checkedAdd?(data.cols?'form-group col-md-'+data.cols*3:'form-group col-md-3'):''" :id="data.key">
    <label :class="data.required?'require':''" v-if="!checkedAdd">{{data.label}}</label>
    <div class="relative">
      <input class="form-control" type="text" :id="data.key+'_input'">
     <!-- <div class="col-md-6 row">
        <input type="text" class="form-control" :id="detailId" placeholder="请填写车系列" @change="handleSetPosition" :value="addArr[data.key+'_detail']">
      </div>-->
    </div>
  </div>

</template>
<style>
</style>
<script>
  import {mapGetters} from 'vuex';
  import * as api from '../api';
  export default{
    data(){
      return {
        position: '',
        cityPicker: "",
        carData:''
      }
    },
    props: ['data','attrsData','checkedAdd'],
    created:function () {
      this.$store.dispatch('setInputData', {key: this.data.key, value: ''})
      var binding=this.data.binding||'';
      var bindingArr=binding.split(',');
      for(var i in bindingArr){
        var item=bindingArr[i];
        this.$store.dispatch('setInputData', {key: item, value: ''})
      }
    },
    mounted: function () {
      if(!this.carData){
        this.getCar300Data()
      }
    },
    computed:{
      ...mapGetters({
        'addData':'car300Data',
      }),
      addArr(){
       var binding=this.data.binding||'';
        var bindingArr=binding.split(',');
        var addArr={};
        var positionArr=[];
        for(var i in bindingArr){
          var item=bindingArr[i];
          var attrValue=this.attrsData[item]||{};
          var value=attrValue ? (attrValue.draftValue==null?(attrValue.attrValue||''):attrValue.draftValue) : '';
          value!=''&&this.$store.dispatch('setInputData', {key: item, value: value});
          addArr[item]=value;
          positionArr.push(value)
        }
        this.$store.dispatch('setInputData', {key: this.data.key, value: positionArr.join(' ').trim()});
        return addArr;
      }
    },
    methods: {
      setbands:function () {
        var position=this.position;
        var posArr=position.split('/');
        var addArr={};
        var positionDetail=[]
        var key=this.data.key;
        addArr[key+'_brand']=posArr[0]||"";
        addArr[key+'_model']=posArr[1]||"";
        addArr[key+'_series']=posArr[2]||"";
        for(var key in addArr){
          var value=addArr[key];
          this.$store.dispatch('setInputData', {key: key, value: value});
          positionDetail.push(value);
        }
        this.$store.dispatch('setInputData', {key: this.data.key, value: positionDetail.join(' ').trim()});
      },
      getCar300Data:function () {
        var _this=this;
        var option={
          url:'/carInfo/info',
          method:'get',
        };
        api.getCar300Data(option,function (data) {
          _this.$nextTick(function () {
            var domId = '#' + this.data.key+'_input';
            if(this.cityPicker){
              $(domId).citypicker('destroy');
            }
            var cityPicker = $(domId).citypicker({
              type:'car',
              disc:['车品牌','车系列','车型号'],
              placeholder: '请选择车品牌/车系列/车型号',
              province:this.addArr[this.data.key+'_brand']||'',
              city:this.addArr[this.data.key+'_model']||'',
              district:this.addArr[this.data.key+'_series']||'',
              data:data
            }, function (data) {
              if (data) {
                _this.position=data;
                _this.setbands();
              }
            });
            if(_this.data.readonly){
              $(domId).citypicker('unbind')
            }
            this.cityPicker = cityPicker;
            this.carData=data;
          })
        })
      }
    }
  }
</script>
