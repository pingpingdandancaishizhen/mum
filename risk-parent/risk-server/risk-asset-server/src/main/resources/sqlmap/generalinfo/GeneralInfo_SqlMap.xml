<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="cn.sunfit.risk.buz.server.dao.generalinfo.GeneralInfoDAO" >
  <resultMap id="BaseResultMap" type="cn.sunfit.risk.buz.api.beans.generalinfo.GeneralInfoListBean" >
    <result column="bp_no" property="bpNo"/>
    <result column="order_source" property="orderSource"/>
    <result column="loan_platform" property="loanPlatform"/>
    <result column="product" property="product"/>
    <result column="cust_name" property="custName"/>
    <result column="cust_id" property="custId"/>
    <result column="contract_no" property="contractNo"/>
    <result column="cust_license_num" property="custLicenseNo"/>
    <result column="cust_type" property="custType"/>
    <result column="apply_date" property="applyDate"/>
    <result column="apply_amount" property="applyAmount"/>
    <result column="loan_apply_monthlyTerm" property="loanApplyMonthlyTerm"/>
    <result column="loan_apply_daylyTerm" property="loanApplyDaylyTerm"/>
    <result column="loan_repayment_method" property="loanRepaymentMethod"/>
    <result column="loan_approval_monthlyTerm" property="loanApprovalMonthlyTerm"/>
    <result column="loan_approval_daylyTerm" property="loanApprovalDaylyTerm"/>
    <result column="loan_approval_bzjFee" property="loanApprovalBzjFee"/>
    <result column="loan_approval_amount" property="loanApprovalAmount"/>
    <result column="loan_approval_repaymentTypes" property="loanApprovalRepaymentTypes"/>
    <result column="car_no" property="carNo"/>
    <result column="owen_store" property="owenStore"/>
    <result column="bp_status" property="bpStatus"/>
    <result column="loan_status" property="loanStatus"/>
    <result column="current_task_name" property="currentTaskName"/>
    <result column="lend_date" property="lendDate"/>
    <result column="repay_status" property="repayStatus"/>
    <result column="repayed_term" property="repayedTerm"/>
  </resultMap>
  
  <sql id="BaseColum">
  	base.bp_id bp_id,
  	base.bp_no bp_no,
	base.order_source order_source,
	base.loan_platform loan_platform,
	base.product product,
	base.cust_name cust_name,
	base.cust_id cust_id,
	base.contract_no contract_no,
	base.cust_license_num cust_license_num,
	base.cust_type cust_type,
	base.apply_date apply_date,
	base.apply_amount apply_amount,
	base.loan_apply_monthlyTerm loan_apply_monthlyTerm,
	base.loan_apply_daylyTerm loan_apply_daylyTerm,
	base.loan_repayment_method loan_repayment_method,
	base.loan_approval_monthlyTerm loan_approval_monthlyTerm,
	base.loan_approval_daylyTerm loan_approval_daylyTerm,
	base.loan_approval_bzjFee loan_approval_bzjFee,
	base.loan_approval_amount loan_approval_amount,
	base.loan_approval_repaymentTypes loan_approval_repaymentTypes,
	base.car_no car_no,
	base.owen_store owen_store,
	base.bp_status bp_status,
	base.loan_status loan_status,
	base.current_task_name current_task_name,
	base.lend_date lend_date,
	base.repay_status repay_status,
	base.repayed_term repayed_term
  </sql>
  
  <sql id="BaseQuerySql">
	  SELECT 
	  	bp.bp_id bp_id,
	  	bp.bp_no bp_no,
		bp.channel order_source,
		partner.name loan_platform,
		prd.product_name product,
		cust.`name` cust_name,
		cust.id cust_id,
		loan.contract_id contract_no,
		cust.license_num cust_license_num,
		cust.type cust_type,
		bp.create_time apply_date,
		loan.apply_amount apply_amount,
		(SELECT a.attr_value FROM ${domain}_bp_attrs a WHERE a.attr_name = 'loan_apply_monthlyTerm' AND a.bp_id = bp.bp_id) loan_apply_monthlyTerm,
		(SELECT a.attr_value FROM ${domain}_bp_attrs a WHERE a.attr_name = 'loan_apply_daylyTerm' AND a.bp_id = bp.bp_id ) loan_apply_daylyTerm,
		(SELECT a.attr_value FROM ${domain}_bp_attrs a WHERE a.attr_name = 'loan_apply_repaymentTypes' AND a.bp_id = bp.bp_id) loan_repayment_method,
		(SELECT a.attr_value FROM ${domain}_bp_attrs a WHERE a.attr_name = 'loanapproval_monthlyTerm' AND a.bp_id = bp.bp_id) loan_approval_monthlyTerm,
		(SELECT a.attr_value FROM ${domain}_bp_attrs a WHERE a.attr_name = 'loanapproval_daylyTerm' AND a.bp_id = bp.bp_id) loan_approval_daylyTerm,
		(SELECT a.attr_value FROM ${domain}_bp_attrs a WHERE a.attr_name = 'loanapproval_bzjFee' AND a.bp_id = bp.bp_id) loan_approval_bzjFee,
		(SELECT a.attr_value FROM ${domain}_bp_attrs a WHERE a.attr_name = 'loanapproval_limit' AND a.bp_id = bp.bp_id) loan_approval_amount,
		(SELECT a.attr_value FROM ${domain}_bp_attrs a WHERE a.attr_name = 'loanapproval_repaymentTypes' AND a.bp_id = bp.bp_id) loan_approval_repaymentTypes,
		loan.car_no car_no,
		dept.dept_name owen_store,
		bp.bp_status bp_status,
		loan.loan_status loan_status,
		bp.current_task_name current_task_name,
		loan.loan_time lend_date,
		repayment.`status` repay_status,
		repayment.payed_issue repayed_term,
		bp.product_type product_type,
		bp.current_task_key current_task_key,
		dept.id dept_id,
		loan.loan_platform loan_platform_key
	FROM ${domain}_risk_bps AS bp
		LEFT JOIN ${domain}_bp_loans AS loan ON bp.bp_id = loan.bp_id
		LEFT JOIN risk_product AS prd ON bp.product_type = prd.id
		LEFT JOIN ${domain}_customers AS cust ON loan.customer_id = cust.id
		LEFT JOIN risk_corp_user `user` on bp.create_user_id = `user`.id
		LEFT JOIN risk_corp_dept dept on dept.id = `user`.dept_id
		LEFT JOIN ${domain}_repayment_base repayment ON repayment.bp_id = bp.bp_id
		LEFT JOIN ${domain}_contract_partner partner ON loan.loan_platform = partner.id
  </sql>
  
  <sql id="QueryBaseCondition">
  	<if test="productType != null and productType != ''">
  		and a.product_type = #{productType}
  	</if>
  	<if test="bpNo != null and bpNo != ''">
		and a.bp_no like concat('%',#{bpNo},'%')
	</if>
	<if test="custName != null and custName != ''">
		and a.cust_name like concat('%',#{custName},'%')
	</if>
	<if test="licenseNo != null and licenseNo != ''">
		and a.cust_license_num like concat('%',#{licenseNo},'%')
	</if>
	<if test="custType != null and custType != ''">
		and a.cust_type = #{custType}
	</if>
	<if test="carNo != null and carNo != ''">
		and a.car_no like concat('%',#{carNo},'%')
	</if>
	<if test="currTaskKey != null and currTaskKey !='' ">
    	and a.current_task_key like concat('%,',#{currTaskKey},',%') 
    </if>
    <if test="contractNo != null and contractNo !='' ">
    	and a.contract_no like concat('%',#{contractNo},'%') 
    </if>
    <if test="applyStartDate != null and applyEndDate !=null ">
    	and a.apply_date between #{applyStartDate} and #{applyEndDate}
    </if>
    <if test="lendStartDate != null and lendEndDate !=null ">
    	and a.lend_date between #{lendStartDate} and #{lendEndDate}
    </if>
    <if test="owenStore != null and owenStore != ''">
		and a.dept_id = #{owenStore}
	</if>
	<if test="daylyTerm != null and daylyTerm != ''">
		and a.loan_approval_daylyTerm = #{daylyTerm}
	</if>
	<if test="monthlyTerm != null and monthlyTerm != ''">
		and a.loan_approval_monthlyTerm = #{monthlyTerm}
	</if>
	<if test="repayStatus != null and repayStatus != ''">
		and a.repay_status = #{repayStatus}
	</if>
	<if test="repayedTerm != null and repayedTerm != ''">
		and a.repayed_term = #{repayedTerm}
	</if>
	<if test="repaymentMethod != null and repaymentMethod != ''">
		and a.loan_approval_repaymentTypes = #{repaymentMethod}
	</if>
	<if test="tenderStartDate != null and tenderEndDate !=null ">
	
    </if>
	<if test="orderSource != null and orderSource != ''">
		and a.order_source = #{orderSource}
	</if>
	<if test="loanPlatform != null and loanPlatform != ''">
		and a.loan_platform_key = #{loanPlatform}
	</if>
  </sql>
  
  <sql id="QueryExtCondition">
  	<if test="productType != null and productType != ''">
  		and base.product_type = #{productType}
  	</if>
  	<if test="bpNo != null and bpNo != ''">
		and base.bp_no like concat('%',#{bpNo},'%')
	</if>
	<if test="custName != null and custName != ''">
		and base.cust_name like concat('%',#{custName},'%')
	</if>
	<if test="licenseNo != null and licenseNo != ''">
		and base.cust_license_num like concat('%',#{licenseNo},'%')
	</if>
	<if test="custType != null and custType != ''">
		and base.cust_type = #{custType}
	</if>
	<if test="carNo != null and carNo != ''">
		and base.car_no like concat('%',#{carNo},'%')
	</if>
	<if test="currTaskKey != null and currTaskKey !='' ">
    	and base.current_task_key like concat('%,',#{currTaskKey},',%') 
    </if>
    <if test="contractNo != null and contractNo !='' ">
    	and base.contract_no like concat('%',#{contractNo},'%') 
    </if>
    <if test="applyStartDate != null and applyEndDate !=null ">
    	and base.apply_date between #{applyStartDate} and #{applyEndDate}
    </if>
    <if test="lendStartDate != null and lendEndDate !=null ">
    	and base.lend_date between #{lendStartDate} and #{lendEndDate}
    </if>
    <if test="owenStore != null and owenStore != ''">
		and base.dept_id = #{owenStore}
	</if>
	<if test="daylyTerm != null and daylyTerm != ''">
		and base.loan_approval_daylyTerm = #{daylyTerm}
	</if>
	<if test="monthlyTerm != null and monthlyTerm != ''">
		and base.loan_approval_monthlyTerm = #{monthlyTerm}
	</if>
	<if test="repayStatus != null and repayStatus != ''">
		and base.repay_status = #{repayStatus}
	</if>
	<if test="repayedTerm != null and repayedTerm != ''">
		and base.repayed_term = #{repayedTerm}
	</if>
	<if test="repaymentMethod != null and repaymentMethod != ''">
		and base.loan_approval_repaymentTypes = #{repaymentMethod}
	</if>
	<if test="tenderStartDate != null and tenderEndDate !=null ">
	
    </if>
	<if test="orderSource != null and orderSource != ''">
		and base.order_source = #{orderSource}
	</if>
	<if test="loanPlatform != null and loanPlatform != ''">
		and base.loan_platform_key = #{loanPlatform}
	</if>
  </sql>
  
  <select id="queryBaseList" parameterType="cn.sunfit.risk.buz.api.vo.generalinfo.GeneralInfoQueryReq" resultMap="BaseResultMap">
  	SELECT <include refid="BaseColum"></include>
	FROM (<include refid="BaseQuerySql"></include>) AS base
	WHERE 
		base.apply_date IN(
			SELECT MAX(a.apply_date) 
			FROM (<include refid="BaseQuerySql"></include>) AS a 
			WHERE 1=1
				<include refid="QueryBaseCondition"></include>
			GROUP BY a.cust_id
		)
	ORDER BY apply_date desc
  </select>
  
  <select id="queryBaseList4Export" parameterType="cn.sunfit.risk.buz.api.vo.generalinfo.GeneralInfoQueryReq" resultMap="BaseResultMap">
  	SELECT <include refid="BaseColum"></include>
	FROM (<include refid="BaseQuerySql"></include>) AS base
	WHERE 
		base.apply_date IN(
			SELECT MAX(a.apply_date) 
			FROM (<include refid="BaseQuerySql"></include>) AS a 
			WHERE 1=1
				<include refid="QueryBaseCondition"></include>
			GROUP BY a.cust_id
		)
	ORDER BY apply_date desc
  </select>
  
  <select id="queryExtralList" parameterType="cn.sunfit.risk.buz.api.vo.generalinfo.GeneralInfoQueryReq" resultMap="BaseResultMap">
  	SELECT <include refid="BaseColum"></include>
	FROM (<include refid="BaseQuerySql"></include>) AS base
	WHERE 
		base.cust_id = #{custId}
		<include refid="QueryExtCondition"></include>
	ORDER BY apply_date desc
	LIMIT 1,9999999;
  </select>
  
</mapper>